// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// –ü–æ–ª–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
model User {
  id            String      @id @default(cuid())
  email         String      @unique
  phone         String?
  password      String      // –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
  name          String
  avatar        String?
  photoUrl      String?     // URL –∏–ª–∏ base64 —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
  online        Boolean     @default(false)
  lastActiveAt  DateTime    @default(now())
  karma         Int         @default(0)
  rating        Float       @default(0)
  
  // –ü—Ä–æ—Ñ–∏–ª—å
  userType      String      // 'parent' –∏–ª–∏ 'nanny'
  location      String?
  birthDate     String?
  bio           String?
  interests     String?     // JSON array
  kids          String?     // JSON array
  
  // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
  latitude      Float?
  longitude     Float?
  
  // –î—Ä—É–∑—å—è (JSON array of emails)
  friends       String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // –ú–∞—Ç—á–∏
  matches1      Match[]     @relation("UserMatches")
  matches2      Match[]     @relation("MatchedWith")

  // –°–æ–æ–±—â–µ–Ω–∏—è
  messagesSent      Message[]         @relation("MessageSender")
  messagesReceived  Message[]         @relation("MessageReceiver")
  
  // –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  reactions         MessageReaction[]
  
  // –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ª–∞–π–∫–∏/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
  reactionsGiven    UserReaction[]    @relation("UserGivesReaction")
  reactionsReceived UserReaction[]    @relation("UserReceivesReaction")
  
  // –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
  boardPosts        BoardPost[]       @relation("BoardPostAuthor")
  boardResponses    BoardResponse[]   @relation("BoardResponder")
  selectedForPosts  BoardPost[]       @relation("SelectedResponder")
  savedPosts        SavedPost[]       @relation("UserSavedPosts")
  
  // –û—Ç–∑—ã–≤—ã
  reviews           Review[]          @relation("UserReviews")
  reviewsGiven      Review[]          @relation("ReviewAuthor")
  
  // –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  bookingsAsClient  Booking[]         @relation("ClientBookings")
  bookingsAsNanny   Booking[]         @relation("NannyBookings")

  @@index([email])
  @@index([userType])
  @@index([location])
}

// –û—Ç–∑—ã–≤—ã
model Review {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  fromUserId      String
  fromUser        User     @relation("ReviewAuthor", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserName    String
  rating          Int
  comment         String
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([fromUserId])
}

// –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
model Booking {
  id          String   @id @default(cuid())
  clientId    String
  client      User     @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  nannyId     String
  nanny       User     @relation("NannyBookings", fields: [nannyId], references: [id], onDelete: Cascade)
  date        String
  status      String   // 'active', 'completed', 'cancelled'
  createdAt   DateTime @default(now())

  @@index([clientId])
  @@index([nannyId])
  @@index([status])
}

// –ú–∞—Ç—á–∏ (–≤–∑–∞–∏–º–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
model Match {
  id          String   @id @default(cuid())
  user1Id     String
  user1       User     @relation("UserMatches", fields: [user1Id], references: [id], onDelete: Cascade)
  user2Id     String
  user2       User     @relation("MatchedWith", fields: [user2Id], references: [id], onDelete: Cascade)

  matchedAt   DateTime @default(now())
  active      Boolean  @default(true)

  // –ß–∞—Ç
  messages    Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([active])
}

// –°–æ–æ–±—â–µ–Ω–∏—è
model Message {
  id          String   @id @default(cuid())
  matchId     String
  match       Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  senderId    String
  sender      User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  content     String
  read        Boolean  @default(false)
  readAt      DateTime?

  reactions   MessageReaction[]

  createdAt   DateTime @default(now())

  @@index([matchId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
model MessageReaction {
  id          String   @id @default(cuid())
  messageId   String
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji       String   // üëç, ‚ù§Ô∏è, üòÇ, üòÆ, üò¢, üò°

  createdAt   DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

// –†–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ª–∞–π–∫–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
model UserReaction {
  id          String   @id @default(cuid())
  fromUserId  String
  fromUser    User     @relation("UserGivesReaction", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUserId    String
  toUser      User     @relation("UserReceivesReaction", fields: [toUserId], references: [id], onDelete: Cascade)
  
  type        String   // 'like' –∏–ª–∏ 'block'
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([type])
}

// –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π - –ø–æ—Å—Ç—ã
model BoardPost {
  id          String   @id @default(cuid())
  authorId    String
  author      User     @relation("BoardPostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  type        String   // 'need_nanny', 'can_babysit', 'playdate', 'looking_for_friends', 'offer_help', 'need_help', 'coffee_meetup', 'other'
  title       String?
  description String
  
  city        String
  district    String?
  
  dateFrom    DateTime?
  dateUntil   DateTime?
  
  status      String   @default("active") // 'active', 'closed'
  viewCount   Int      @default(0)
  
  // –í—ã–±—Ä–∞–Ω–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)
  selectedResponderId String?
  selectedResponder   User?    @relation("SelectedResponder", fields: [selectedResponderId], references: [id], onDelete: SetNull)
  
  responses   BoardResponse[]
  savedBy     SavedPost[]     @relation("SavedByUsers")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
  @@index([type])
  @@index([city])
  @@index([status])
  @@index([createdAt])
}

// –û—Ç–∫–ª–∏–∫–∏ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
model BoardResponse {
  id          String   @id @default(cuid())
  postId      String
  post        BoardPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  responderId String
  responder   User     @relation("BoardResponder", fields: [responderId], references: [id], onDelete: Cascade)
  
  message     String
  contacted   Boolean  @default(false)
  
  createdAt   DateTime @default(now())

  @@index([postId])
  @@index([responderId])
  @@index([createdAt])
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–∏–∑–±—Ä–∞–Ω–Ω–æ–µ)
model SavedPost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserSavedPosts", fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      BoardPost @relation("SavedByUsers", fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}
